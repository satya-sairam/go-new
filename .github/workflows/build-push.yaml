# # name: Build, Scan & Push on Commit

# # on:
# #   push:
# #     branches:
# #       - main

# # env:
# #   IMAGE_NAME: satya1122/myapp
# #   TRIVY_VERSION: 0.58.0

# # jobs:
# #   build-scan-push:
# #     runs-on: ubuntu-latest
# #     permissions:
# #       contents: write
# #       packages: write

# #     steps:
# #       - name: Checkout code
# #         uses: actions/checkout@v4
# #         with:
# #           fetch-depth: 0

# #       - name: Generate tag from commit
# #         id: tag
# #         run: |
# #           # Create tag from date and short commit SHA
# #           TAG="$(date +%Y%m%d)-${GITHUB_SHA::7}"
# #           COMMIT_SHA="${GITHUB_SHA::7}"
# #           echo "tag=${TAG}" >> $GITHUB_OUTPUT
# #           echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
# #           echo " Generated TAG: ${TAG}"
# #           echo " Commit SHA: ${COMMIT_SHA}"

# #       - name: Set up QEMU
# #         uses: docker/setup-qemu-action@v3

# #       - name: Set up Docker Buildx
# #         uses: docker/setup-buildx-action@v3

# #       - name: Login to Docker Hub
# #         uses: docker/login-action@v3
# #         with:
# #           username: ${{ secrets.DOCKERHUB_USERNAME }}
# #           password: ${{ secrets.DOCKERHUB_TOKEN }}

# #       - name: Build Docker image (load locally for scanning)
# #         uses: docker/build-push-action@v5
# #         with:
# #           context: .
# #           file: ./Dockerfile
# #           tags: |
# #             ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
# #             ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.commit_sha }}
# #           load: true
# #           cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
# #           cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

# #       - name: Show built images
# #         run: docker images | grep ${{ env.IMAGE_NAME }}

# #       - name: Install Trivy
# #         run: |
# #           curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${{ env.TRIVY_VERSION }}
# #           trivy --version

# #       - name: Trivy Scan - Filesystem (non-blocking)
# #         run: |
# #           echo " Running Trivy filesystem scan..."
# #           trivy fs \
# #             --exit-code 0 \
# #             --no-progress \
# #             --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
# #             .
# #         continue-on-error: true

# #       - name: Trivy Scan - Image (non-blocking)
# #         run: |
# #           IMAGE="${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
# #           echo " Scanning Docker image: ${IMAGE}"
# #           trivy image \
# #             --exit-code 0 \
# #             --no-progress \
# #             --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
# #             "${IMAGE}"
# #         continue-on-error: true

# #       - name: Push image to DockerHub
# #         uses: docker/build-push-action@v5
# #         with:
# #           context: .
# #           file: ./Dockerfile
# #           push: true
# #           tags: |
# #             ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
# #             ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.commit_sha }}
# #           cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache

# #       - name: Create and push Git tag
# #         run: |
# #           TAG="${{ steps.tag.outputs.tag }}"
# #           git config user.name "github-actions[bot]"
# #           git config user.email "github-actions[bot]@users.noreply.github.com"
# #           git tag -a "${TAG}" -m "Automated release ${TAG}"
# #           git push origin "${TAG}"

# #       - name: Summary
# #         run: |
# #           echo " Pipeline completed successfully!"
# #           echo " Image pushed: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
# #           echo " Commit tag: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.commit_sha }}"
# #           echo "  Git tag created: ${{ steps.tag.outputs.tag }}"


# name: Build, Scan & Push on Tag or Commit

# on:
#   push:
#     branches:
#       - '*'       # Trigger on all branches
#     tags:
#       - '*'       # Also trigger when a tag is pushed

# env:
#   IMAGE_NAME: satya1122/myapp
#   TRIVY_VERSION: 0.58.0

# jobs:
#   build-scan-push:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
#       packages: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v5
#         with:
#           fetch-depth: 0

#       - name: Determine Image Tag
#         id: vars
#         run: |
#           if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
#             TAG_NAME="${GITHUB_REF_NAME}"
#           else
#             TAG_NAME="$(echo ${GITHUB_REF_NAME} | tr '/' '-')-latest"
#           fi
#           echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
#           echo "Using tag: ${TAG_NAME}"

#       - name: Set up QEMU
#         uses: docker/setup-qemu-action@v3

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Build Docker image (load locally for scanning)
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./Dockerfile
#           tags: |
#             ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}
#           load: true
#           cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
#           cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

#       - name: Show built images
#         run: docker images | grep ${{ env.IMAGE_NAME }}

#       - name: Install Trivy
#         run: |
#           curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${{ env.TRIVY_VERSION }}
#           trivy --version

#       - name: Trivy Scan - Filesystem (non-blocking)
#         run: |
#           trivy fs --exit-code 0 --no-progress --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL .
#         continue-on-error: true

#       - name: Trivy Scan - Image (non-blocking)
#         run: |
#           IMAGE="${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}"
#           trivy image --exit-code 0 --no-progress --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL "${IMAGE}"
#         continue-on-error: true

#       - name: Push image to DockerHub
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./Dockerfile
#           push: true
#           tags: |
#             ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}
#           cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache

#       - name: Summary
#         run: |
#           echo "‚úÖ Pipeline completed successfully!"
#           echo "Docker Image pushed: ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}"



name: Build, Scan & Push (Tag-Aware)

on:
  push:
    branches:
      - '*'     # Trigger on all branches
    tags:
      - '*'     # Also trigger on tag pushes

env:
  IMAGE_NAME: satya1122/myapp
  TRIVY_VERSION: 0.58.0

jobs:
  build-scan-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine Image Tag
        id: vars
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG_NAME="${GITHUB_REF_NAME}"
            PUSH_IMAGE=true
          else
            TAG_NAME="dev-${GITHUB_REF_NAME//\//-}"
            PUSH_IMAGE=false
          fi
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "push_image=${PUSH_IMAGE}" >> $GITHUB_OUTPUT
          echo "üü¶ Using tag: ${TAG_NAME}"
          echo "üü© Push image: ${PUSH_IMAGE}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.vars.outputs.push_image == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image (load locally for scanning)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}
          load: true
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Show built images
        run: docker images | grep ${{ env.IMAGE_NAME }}

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | \
            sh -s -- -b /usr/local/bin v${{ env.TRIVY_VERSION }}
          trivy --version

      - name: Trivy Scan - Filesystem (non-blocking)
        run: |
          echo "üîç Running Trivy filesystem scan..."
          trivy fs --exit-code 0 --no-progress --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL .
        continue-on-error: true

      - name: Trivy Scan - Image (non-blocking)
        run: |
          IMAGE="${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}"
          echo "üîç Scanning Docker image: ${IMAGE}"
          trivy image --exit-code 0 --no-progress --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL "${IMAGE}"
        continue-on-error: true

      - name: Push image to DockerHub (only for tags)
        if: steps.vars.outputs.push_image == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache

      - name: Summary
        run: |
          echo "‚úÖ Pipeline completed successfully!"
          echo "üñºÔ∏è  Image tag: ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag_name }}"
          echo "üì¶ Pushed to DockerHub: ${{ steps.vars.outputs.push_image }}"
